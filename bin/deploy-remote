#!/usr/bin/env bash

set -euo pipefail

usage() {
  echo "Usage: $0 --host user@server [--path ~/.dotfiles] [--unattended]"
}

HOST=""
REMOTE_PATH="~/.dotfiles"
UNATTENDED="false"

while [[ $# -gt 0 ]]; do
  case "$1" in
    --host)
      HOST="$2"; shift 2 ;;
    --path)
      REMOTE_PATH="$2"; shift 2 ;;
    --unattended)
      UNATTENDED="true"; shift ;;
    -h|--help)
      usage; exit 0 ;;
    *)
      echo "Unknown arg: $1"; usage; exit 1 ;;
  esac
done

if [[ -z "${HOST}" ]]; then
  echo "--host is required"; usage; exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "${SCRIPT_DIR}/.." && pwd)"

rsync -a --delete --exclude ".git" --exclude "wezterm/static/back.jpg" "${REPO_ROOT}/" "${HOST}:${REMOTE_PATH}/"

ssh -o BatchMode=yes -o StrictHostKeyChecking=accept-new "${HOST}" "bash -lc 'cd ${REMOTE_PATH} && chmod +x bin/install && bin/install ${UNATTENDED:+--unattended}'"

echo "Remote deploy complete"


